min_version = "2026.1.8"

[settings]
auto_install           = true
not_found_auto_install = true
task_run_auto_install  = true

[settings.status]
show_tools = true
show_env   = false
truncate   = true

[tools]
docker-cli    = "29.2.1"
node          = "25.6.0"
ansible       = "13.3.0"
ansible-core  = "2.20.2"
helm          = "4.1.0"
kubectl       = "1.35.0"
kustomize     = "5.8.0"
kubeconform   = "0.7.0"
kube-linter   = "0.8.1"
helm-diff     = { version = "3.15.0", bin_path = "diff/bin", rename_exe = "helm-diff", exe = "diff" }
kubeseal      = "0.34.0"
trivy         = "0.69.0"
terraform     = "1.14.4"
python        = "3.14.3"
uv            = "0.9.30"
shellcheck    = "0.11.0"
yamllint      = "1.38.0"
eza           = "0.23.4"
fd            = "10.3.0"
rg            = "15.1.0"
git-cliff     = "2.12.0"
datree        = "1.9.19"
yarn          = "4.12.0"
yq            = "4.52.2"
prek          = "0.3.1"
pnpm          = "latest"
golangci-lint = "2.8.0"
npm = "11.9.0"
go = "1.25.7"

[env]
_.python.venv = { path = ".venv", create = true }

[tasks.hooks-install]
description = "Install prek hooks"
run         = "prek install -f"

[tasks.pre-commit-run]
description = "Run prek hooks"
run         = "prek run --all-files"

[tasks.markdown-lint]
description = "Lint Markdown files"
run         = "rumdl check ."

[tasks.markdown-fix]
description = "Fix Markdown files"
run         = "rumdl fmt ."

[tasks.path-drift]
description = "Check for deprecated paths"
run         = "tools/ci/path-drift-check.sh"

[tasks.sensitive-files]
description = "Check for sensitive filenames"
run         = "tools/ci/sensitive-files-check.sh"

[tasks.helm-deps-update]
description = "Update Helm chart dependencies"
run = """
set -euo pipefail
for chart in apps/cluster/*/ apps/user/*/; do
  if [ -f "${chart}Chart.yaml" ]; then
    helm dependency update "${chart}"
  fi
done
"""

[tasks.helm-lint]
description = "Lint Helm charts"
run = """
set -euo pipefail
for chart in apps/cluster/*/ apps/user/*/; do
  if [ -f "${chart}Chart.yaml" ]; then
    helm lint "${chart}"
  fi
done
"""

[tasks.k8s-lint]
description = "Lint Helm charts and validate Kubernetes manifests"
run         = "tools/ci/k8s-lint.sh"

[tasks.ansible-idempotency]
description = "Check Ansible playbooks for idempotency issues"
run = """
set -euo pipefail
if [ ! -d ansible/playbooks ]; then
  echo "ansible/playbooks not found; skipping."
  exit 0
fi
files=$(find ansible/playbooks -maxdepth 1 -type f -name "*.yml"; find ansible/playbooks -maxdepth 1 -type f -name "*.yaml")
if [ -z "$files" ]; then
  echo "No playbooks found; skipping."
  exit 0
fi
tools/ci/check-idempotency.sh $files
"""

[tasks.terraform-validate]
description = "Terraform fmt+validate (lab env, no backend)"
run = """
set -euo pipefail
terraform -chdir=terraform fmt -check -recursive
terraform -chdir=terraform/envs/lab init -backend=false
terraform -chdir=terraform/envs/lab validate
"""

[tasks.changelog]
description = "Generate CHANGELOG.md from conventional commits"
run         = "git-cliff --config cliff.toml --output CHANGELOG.md"

[tasks.changelog-unreleased]
description = "Preview unreleased changelog entries"
run         = "git-cliff --config cliff.toml --unreleased"

[tasks.harbor-warm]
description = "Stage and warm Harbor proxy cache from manifest"
run         = "tools/patching/scripts/warm-all.sh"

[tasks.harbor-warm-dry]
description = "Dry-run: show what harbor-warm would do"
run         = "tools/patching/scripts/warm-all.sh --dry-run"

[tasks.harbor-stage]
description = "Stage base images only (no cache warming)"
run         = "tools/patching/scripts/stage-base-images.sh"

[tasks.harbor-stage-oci]
description = "Stage OCI artifacts (charts) via Harbor proxy cache"
run         = "tools/patching/scripts/stage-oci-artifacts.sh"

[tasks.harbor-stage-oci-dry]
description = "Dry-run: show what harbor-stage-oci would do"
run         = "tools/patching/scripts/stage-oci-artifacts.sh --dry-run"
