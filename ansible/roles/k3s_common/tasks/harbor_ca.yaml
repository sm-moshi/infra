---
- name: Install Harbor CA into system trust store
  ansible.builtin.copy:
    src: "{{ harbor_ca_src | default(playbook_dir ~ '/../files/harbor-ca.crt') }}"
    dest: "{{ harbor_ca_dest | default('/usr/local/share/ca-certificates/harbor-ca.crt') }}"
    owner: root
    group: root
    mode: "0644"
  register: harbor_ca_install
  become: true
  when: k3s_enable_harbor_mirrors | default(false)

- name: Update CA trust store
  ansible.builtin.command: update-ca-certificates
  register: harbor_ca_update
  changed_when: "'0 added' not in (harbor_ca_update.stdout | default(''))"
  become: true
  when:
    - k3s_enable_harbor_mirrors | default(false)
    - harbor_ca_install is changed
