---
# Extra configuration for Tailscale subnet routing on Proxmox
- name: "Tailscale router | Install sysctl config for IPv4 forwarding"
  ansible.builtin.copy:
    dest: /etc/sysctl.d/99-tailscale-router.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      net.ipv4.ip_forward = 1
      net.ipv4.conf.all.forwarding = 1
      net.ipv4.conf.default.forwarding = 1
  when: tailscale_router_enable | default(false)

- name: "Tailscale router | Install forwarding fix script"
  ansible.builtin.template:
    src: tailscale-router-fix.sh.j2
    dest: /usr/local/bin/tailscale-router-fix.sh
    owner: root
    group: root
    mode: "0755"
  when: tailscale_router_enable | default(false)

- name: "Tailscale router | Install systemd unit"
  ansible.builtin.copy:
    dest: /etc/systemd/system/tailscale-router-fix.service
    owner: root
    group: root
    mode: "0644"
    content: |
      [Unit]
      Description=Fix forwarding for Tailscale subnet routing on Proxmox
      DefaultDependencies=no
      Before=network-pre.target
      Before=tailscaled.service
      Wants=network-pre.target

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/tailscale-router-fix.sh

      [Install]
      WantedBy=multi-user.target
  when: tailscale_router_enable | default(false)

- name: "Tailscale router | Reload systemd and enable service"
  ansible.builtin.systemd:
    name: tailscale-router-fix.service
    enabled: true
    daemon_reload: true
  when:
    - tailscale_router_enable | default(false)
    - not ansible_check_mode

# Optional: run the fix once now (so you don't need to reboot immediately)
- name: "Tailscale router | Run forwarding fix now"
  ansible.builtin.command: /usr/local/bin/tailscale-router-fix.sh
  when:
    - tailscale_router_enable | default(false)
    - not ansible_check_mode
  changed_when: false
