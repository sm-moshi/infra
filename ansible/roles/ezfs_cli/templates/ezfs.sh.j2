{% raw -%}
#!/usr/bin/env bash
set -euo pipefail

# ezfs - small ZFS/Proxmox helper CLI
#
# Subcommands:
#
#   ezfs zvol map [POOL_PREFIX]
#
#   ezfs report space vm [POOL_PREFIX]
#   ezfs report health pool [POOL...]
#   ezfs report usb [--dmesg]
#
#   ezfs snapshot vm <ID> [--keep N] [--prefix STR] [--note STRING]
#   ezfs snapshot all [--keep N] [--prefix STR] [--note STRING] [--running-only]
#
# Defaults for snapshot naming and retention can be overridden via env:
#   EZFS_SNAPSHOT_PREFIX          (default: ezsnap)
#   EZFS_SNAPSHOT_TIMEFMT         (default: %Y%m%d-%H%M%S)
#   EZFS_SNAPSHOT_DEFAULT_KEEP    (default: 8)
#

SNAP_PREFIX="${EZFS_SNAPSHOT_PREFIX:-ezsnap}"
SNAP_TIMEFMT="${EZFS_SNAPSHOT_TIMEFMT:-%Y%m%d-%H%M%S}"
SNAP_DEFAULT_KEEP="${EZFS_SNAPSHOT_DEFAULT_KEEP:-8}"

human() {
  local num="$1"
  awk -v b="$num" '
    function human(x) {
      s="BKMGTPEZY";i=1;
      while (x>=1024 && i<length(s)) {x/=1024;i++}
      return sprintf("%.1f%s", x, substr(s,i,1))
    }
    BEGIN {print human(b)}
  '
}

usage() {
  cat >&2 <<EOF
Usage:
  ezfs zvol map [POOL_PREFIX]

  ezfs report space vm [POOL_PREFIX]
  ezfs report health pool [POOL...]
  ezfs report usb [--dmesg]

  ezfs snapshot vm <ID> [--keep N] [--prefix STR] [--note STRING]
  ezfs snapshot all [--keep N] [--prefix STR] [--note STRING] [--running-only]

Environment overrides:
  EZFS_SNAPSHOT_PREFIX          (default: ${SNAP_PREFIX})
  EZFS_SNAPSHOT_TIMEFMT         (default: ${SNAP_TIMEFMT})
  EZFS_SNAPSHOT_DEFAULT_KEEP    (default: ${SNAP_DEFAULT_KEEP})
EOF
  exit 1
}

# --- helpers: Proxmox metadata ------------------------------------------------

get_vm_name() {
  local id="$1"
  qm config "$id" 2>/dev/null | awk -F: '/^name:/ {gsub(/^ +/, "", $2); print $2}' || true
}

get_ct_name() {
  local id="$1"
  pct config "$id" 2>/dev/null | awk -F: '/^hostname:/ {gsub(/^ +/, "", $2); print $2}' || true
}

# --- zvol map -----------------------------------------------------------------

cmd_zvol_map() {
  local pool_filter="${1:-}"

  local zvols
  if [[ -n "$pool_filter" ]]; then
    zvols=$(zfs list -H -o name -t volume | awk -v p="$pool_filter" '$0 ~ "^"p"/"')
  else
    zvols=$(zfs list -H -o name -t volume)
  fi

  printf "%-8s  %-40s  %-3s  %-5s  %s\n" "DEV" "ZVOL" "T" "ID" "NAME"
  printf "%-8s  %-40s  %-3s  %-5s  %s\n" "--------" "----------------------------------------" "---" "-----" "------------------------------"

  while read -r vol; do
    [[ -z "$vol" ]] && continue

    local dev_path dev id type name
    dev_path=$(readlink -f "/dev/zvol/$vol" 2>/dev/null || true)
    [[ -z "$dev_path" ]] && continue

    dev=$(basename "$dev_path")
    id=$(echo "$vol" | sed -n 's/.*\(vm-\|subvol-\)\([0-9]\+\)-.*/\2/p')
    type="-"
    name="-"

    if [[ -n "${id:-}" ]]; then
      if qm config "$id" &>/dev/null; then
        type="VM"
        name=$(get_vm_name "$id")
      elif pct config "$id" &>/dev/null; then
        type="CT"
        name=$(get_ct_name "$id")
      fi
      [[ -z "$name" ]] && name="-"
    fi

    printf "%-8s  %-40s  %-3s  %-5s  %s\n" "$dev" "$vol" "$type" "${id:-"-"}" "$name"
  done <<< "$zvols"
}

# --- report: VM space ---------------------------------------------------------

cmd_report_space_vm() {
  local pool_filter="${1:-}"

  local zvols
  if [[ -n "$pool_filter" ]]; then
    zvols=$(zfs list -H -o name -t volume | awk -v p="$pool_filter" '$0 ~ "^"p"/"')
  else
    zvols=$(zfs list -H -o name -t volume)
  fi

  declare -A USED_BYTES
  declare -A TYPE_MAP
  declare -A NAME_MAP

  while read -r vol; do
    [[ -z "$vol" ]] && continue
    local id used
    id=$(echo "$vol" | sed -n 's/.*\(vm-\|subvol-\)\([0-9]\+\)-.*/\2/p')
    [[ -z "$id" ]] && continue

    used=$(zfs get -Hp -o value used "$vol" 2>/dev/null || echo 0)
    USED_BYTES["$id"]=$(( ${USED_BYTES["$id"]:-0} + used ))

    if [[ -z "${TYPE_MAP["$id"]:-}" || -z "${NAME_MAP["$id"]:-}" || "${NAME_MAP["$id"]}" = "-" ]]; then
      if qm config "$id" &>/dev/null; then
        TYPE_MAP["$id"]="VM"
        NAME_MAP["$id"]=$(get_vm_name "$id")
      elif pct config "$id" &>/dev/null; then
        TYPE_MAP["$id"]="CT"
        NAME_MAP["$id"]=$(get_ct_name "$id")
      else
        TYPE_MAP["$id"]="-"
        NAME_MAP["$id"]="-"
      fi
      [[ -z "${NAME_MAP["$id"]}" ]] && NAME_MAP["$id"]="-"
    fi
  done <<< "$zvols"

  if [[ "${#USED_BYTES[@]}" -eq 0 ]]; then
    echo "No VM/CT zvols found."
    return 0
  fi

  mapfile -t SORTED_IDS < <(
    for id in "${!USED_BYTES[@]}"; do
      printf "%s %s\n" "${USED_BYTES["$id"]}" "$id"
    done | sort -rn | awk '{print $2}'
  )

  printf "%-5s  %-3s  %-24s  %-10s\n" "ID" "T" "NAME" "USED"
  printf "%-5s  %-3s  %-24s  %-10s\n" "-----" "---" "------------------------" "----------"

  for id in "${SORTED_IDS[@]}"; do
    local used type name
    used="${USED_BYTES["$id"]}"
    type="${TYPE_MAP["$id"]:-"-"}"
    name="${NAME_MAP["$id"]:-"-"}"
    printf "%-5s  %-3s  %-24s  %-10s\n" "$id" "$type" "$name" "$(human "$used")"
  done
}

# --- report: pool health / properties ----------------------------------------

cmd_report_health_pool() {
  local pools=("$@")

  if [[ "${#pools[@]}" -eq 0 ]]; then
    mapfile -t pools < <(zpool list -H -o name 2>/dev/null || true)
  fi

  if [[ "${#pools[@]}" -eq 0 ]]; then
    echo "No pools found."
    return 0
  fi

  for pool in "${pools[@]}"; do
    echo "=== Pool: $pool ==="
    local _ size alloc free cap health _
    read -r _ size alloc free cap health _ <<<"$(zpool list -H -o name,size,alloc,free,cap,health -p "$pool")"

    echo "  Size:    $size  ($([[ "$size" =~ ^[0-9]+$ ]] && human "$size" || echo "$size"))"
    echo "  Alloc:   $alloc ($([[ "$alloc" =~ ^[0-9]+$ ]] && human "$alloc" || echo "$alloc"))"
    echo "  Free:    $free  ($([[ "$free" =~ ^[0-9]+$ ]] && human "$free" || echo "$free"))"
    echo "  Cap:     $cap"
    echo "  Health:  $health"

    local props=(ashift autotrim listsnapshots readonly)
    for p in "${props[@]}"; do
      local val
      val=$(zpool get -H -o value "$p" "$pool" 2>/dev/null || echo "-")
      echo "  $p: $val"
    done

    echo "  Devices:"
    zpool status -P "$pool" 2>/dev/null | \
      awk '
        /^\t/ {
          gsub(/^\t+/, "", $1);
          if ($1 ~ /^\/dev\//) {
            print "    - " $1
          }
        }
      '
    echo ""
  done
}

# --- report: USB --------------------------------------------------------------

is_usb_device() {
  local blk="$1"
  local path="/sys/block/${blk}/device"
  if [[ -e "$path" ]]; then
    if readlink -f "$path" | grep -q "/usb"; then
      return 0
    fi
  fi
  return 1
}

get_driver() {
  local blk="$1"
  local p="/sys/block/${blk}/device/driver"
  if [[ -L "$p" ]]; then
    basename "$(readlink -f "$p")"
  else
    echo "-"
  fi
}

cmd_report_usb() {
  local show_dmesg=0
  if [[ "${1:-}" == "--dmesg" ]]; then
    show_dmesg=1
    shift || true
  fi

  echo "=== USB Storage Topology (lsusb -t) ==="
  if command -v lsusb >/dev/null 2>&1; then
    lsusb -t
  else
    echo "lsusb not found."
  fi
  echo ""

  echo "=== ZFS Pools Using USB-Backed Devices ==="

  local pools
  pools=$(zpool list -H -o name 2>/dev/null || true)
  if [[ -z "$pools" ]]; then
    echo "No ZFS pools found."
    return 0
  fi

  local found_any=0

  for pool in $pools; do
    mapfile -t devs < <(
      zpool status -P "$pool" 2>/dev/null | \
      awk '
        /^\t/ {
          gsub(/^\t+/, "", $1);
          if ($1 ~ /^\/dev\//) {
            print $1
          }
        }
      ' | sort -u
    )

    [[ "${#devs[@]}" -eq 0 ]] && continue

    local header_printed=0

    for devpath in "${devs[@]}"; do
      local realpath blk driver
      realpath=$(readlink -f "$devpath" 2>/dev/null || echo "$devpath")
      blk=$(basename "$realpath")

      if [[ ! "$blk" =~ ^sd[a-z]+$ ]]; then
        continue
      fi

      if is_usb_device "$blk"; then
        if [[ "$header_printed" -eq 0 ]]; then
          echo "--- Pool: $pool ---"
          printf "  %-8s  %-10s  %-12s  %s\n" "BLOCK" "USB?" "DRIVER" "PATH"
          header_printed=1
          found_any=1
        fi
        driver=$(get_driver "$blk")
        printf "  %-8s  %-10s  %-12s  %s\n" "$blk" "yes" "$driver" "$realpath"
      fi
    done
  done

  if [[ "$found_any" -eq 0 ]]; then
    echo "No ZFS pool leaf devices detected as USB-backed."
  fi

  if [[ "$show_dmesg" -eq 1 ]]; then
    echo ""
    echo "=== Recent USB-related dmesg ==="
    dmesg | grep -Ei 'usb|uas' | tail -n 80 || true
  fi
}

# --- snapshot: VM / ALL -------------------------------------------------------

snapshot_timestamp() {
  date +"$SNAP_TIMEFMT"
}

snapshot_sanitize_note() {
  local n="$1"
  n=$(echo "$n" | tr ' ' '_' | tr -cd '[:alnum:]_-')
  echo "$n"
}

snapshot_vm_datasets() {
  local id="$1"
  local zvols fss
  zvols=$(zfs list -H -o name -t volume 2>/dev/null | grep -E "/vm-${id}-disk-|/subvol-${id}-disk-" || true)
  fss=$(zfs list -H -o name -t filesystem 2>/dev/null | grep -E "/vm-${id}-disk-|/subvol-${id}-disk-" || true)
  printf "%s\n%s\n" "$zvols" "$fss" | awk 'NF' | sort -u
}

snapshot_apply_retention() {
  local ds="$1"
  local prefix="$2"
  local keep="$3"

  if ! [[ "$keep" =~ ^[0-9]+$ ]] || [[ "$keep" -le 0 ]]; then
    return 0
  fi

  mapfile -t snaps < <(
    zfs list -H -t snapshot -o name -s creation "$ds" 2>/dev/null | \
    grep -E "^${ds}@${prefix}-" || true
  )

  local count="${#snaps[@]}"
  if [[ "$count" -le "$keep" ]]; then
    return 0
  fi

  local to_delete=$((count - keep))
  echo "  -> retention for ${ds}: ${count} snapshots, deleting ${to_delete} oldest"
  local i
  for ((i=0; i<to_delete; i++)); do
    echo "     zfs destroy ${snaps[$i]}"
    zfs destroy "${snaps[$i]}"
  done
}

cmd_snapshot_vm() {
  local id keep prefix note
  if [[ $# -lt 1 ]]; then
    echo "Usage: ezfs snapshot vm <ID> [--keep N] [--prefix STR] [--note STRING]" >&2
    exit 1
  fi

  id="$1"
  shift || true

  keep="$SNAP_DEFAULT_KEEP"
  prefix="$SNAP_PREFIX"
  note=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --keep)
        shift || true
        [[ $# -gt 0 ]] || { echo "--keep requires a value" >&2; exit 1; }
        keep="$1"
        ;;
      --prefix)
        shift || true
        [[ $# -gt 0 ]] || { echo "--prefix requires a value" >&2; exit 1; }
        prefix="$1"
        ;;
      --note)
        shift || true
        [[ $# -gt 0 ]] || { echo "--note requires a value" >&2; exit 1; }
        note="$1"
        ;;
      *)
        echo "Unknown option: $1" >&2
        exit 1
        ;;
    esac
    shift || true
  done

  if ! [[ "$id" =~ ^[0-9]+$ ]]; then
    echo "ID must be numeric (VMID/CTID)." >&2
    exit 1
  fi

  local ts snap_name
  ts="$(snapshot_timestamp)"
  snap_name="${prefix}-${ts}"

  if [[ -n "$note" ]]; then
    local sn
    sn="$(snapshot_sanitize_note "$note")"
    if [[ -n "$sn" ]]; then
      snap_name="${snap_name}-${sn}"
    fi
  fi

  echo "Creating snapshots for ID=${id} with name=@${snap_name} (keep=${keep})"

  local datasets
  datasets=$(snapshot_vm_datasets "$id")
  if [[ -z "$datasets" ]]; then
    echo "No datasets found for ID ${id}." >&2
    exit 1
  fi

  local ds
  while read -r ds; do
    [[ -z "$ds" ]] && continue
    local snap="${ds}@${snap_name}"
    echo "  -> snapshot ${snap}"
    zfs snapshot "$snap"
  done <<< "$datasets"

  while read -r ds; do
    [[ -z "$ds" ]] && continue
    snapshot_apply_retention "$ds" "$prefix" "$keep"
  done <<< "$datasets"

  echo "Done."
}

cmd_snapshot_all() {
  local keep prefix note running_only
  keep="$SNAP_DEFAULT_KEEP"
  prefix="$SNAP_PREFIX"
  note=""
  running_only=0

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --keep)
        shift || true
        [[ $# -gt 0 ]] || { echo "--keep requires a value" >&2; exit 1; }
        keep="$1"
        ;;
      --prefix)
        shift || true
        [[ $# -gt 0 ]] || { echo "--prefix requires a value" >&2; exit 1; }
        prefix="$1"
        ;;
      --note)
        shift || true
        [[ $# -gt 0 ]] || { echo "--note requires a value" >&2; exit 1; }
        note="$1"
        ;;
      --running-only)
        running_only=1
        ;;
      *)
        echo "Unknown option: $1" >&2
        exit 1
        ;;
    esac
    shift || true
  done

  local ids=()

  if command -v qm >/dev/null 2>&1; then
    if [[ "$running_only" -eq 1 ]]; then
      while read -r line; do
        local id state
        id=$(awk '{print $1}' <<<"$line")
        state=$(awk '{print $3}' <<<"$line")
        [[ "$id" =~ ^[0-9]+$ ]] || continue
        [[ "$state" == "running" ]] || continue
        ids+=("$id")
      done < <(qm list 2>/dev/null | awk 'NR>1')
    else
      while read -r line; do
        local id
        id=$(awk '{print $1}' <<<"$line")
        [[ "$id" =~ ^[0-9]+$ ]] || continue
        ids+=("$id")
      done < <(qm list 2>/dev/null | awk 'NR>1')
    fi
  fi

  if command -v pct >/dev/null 2>&1; then
    if [[ "$running_only" -eq 1 ]]; then
      while read -r line; do
        local id status
        id=$(awk '{print $1}' <<<"$line")
        status=$(awk '{print $5}' <<<"$line")
        [[ "$id" =~ ^[0-9]+$ ]] || continue
        [[ "$status" == "running" ]] || continue
        ids+=("$id")
      done < <(pct list 2>/dev/null | awk 'NR>1')
    else
      while read -r line; do
        local id
        id=$(awk '{print $1}' <<<"$line")
        [[ "$id" =~ ^[0-9]+$ ]] || continue
        ids+=("$id")
      done < <(pct list 2>/dev/null | awk 'NR>1')
    fi
  fi

  if [[ "${#ids[@]}" -eq 0 ]]; then
    echo "No VM/CT IDs found."
    exit 0
  fi

  echo "Snapshotting ${#ids[@]} guests (running-only=${running_only}, keep=${keep}, prefix=${prefix})"
  local id
  for id in "${ids[@]}"; do
    echo ""
    echo "=== ID ${id} ==="
    cmd_snapshot_vm "$id" --keep "$keep" --prefix "$prefix" ${note:+--note "$note"}
  done
}

# --- main dispatcher ----------------------------------------------------------

main() {
  [[ $# -lt 1 ]] && usage

  local cmd="$1"; shift || true

  case "$cmd" in
    zvol)
      [[ $# -lt 1 ]] && usage
      case "$1" in
        map)
          shift || true
          cmd_zvol_map "${1:-}"
          ;;
        *)
          usage
          ;;
      esac
      ;;
    report)
      [[ $# -lt 1 ]] && usage
      local report_type="$1"; shift || true
      case "$report_type" in
        space)
          [[ $# -lt 1 ]] && usage
          case "$1" in
            vm)
              shift || true
              cmd_report_space_vm "${1:-}"
              ;;
            *)
              echo "Unknown 'report space' target: $1" >&2
              usage
              ;;
          esac
          ;;
        health)
          [[ $# -lt 1 ]] && usage
          case "$1" in
            pool)
              shift || true
              cmd_report_health_pool "$@"
              ;;
            *)
              echo "Unknown 'report health' target: $1" >&2
              usage
              ;;
          esac
          ;;
        usb)
          # allow both 'ezfs report usb' and 'ezfs report usb --dmesg'
          cmd_report_usb "$@"
          ;;
        *)
          echo "Unknown report type: $report_type" >&2
          usage
          ;;
      esac
      ;;
    snapshot)
      [[ $# -lt 1 ]] && usage
      local snap_target="$1"; shift || true
      case "$snap_target" in
        vm)
          cmd_snapshot_vm "$@"
          ;;
        all)
          cmd_snapshot_all "$@"
          ;;
        *)
          echo "Unknown snapshot target: $snap_target" >&2
          usage
          ;;
      esac
      ;;
    *)
      echo "Unknown command: $cmd" >&2
      usage
      ;;
  esac
}

main "$@"
{%- endraw %}
