#!/usr/bin/env bash
set -euo pipefail

# ezfs-snapshot-all
#
# Snapshot all VMs and CTs on this node by calling ezfs-snapshot-vm for each ID.
#
# Usage:
#   ezfs-snapshot-all [--keep N] [--prefix STR] [--note STRING] [--running-only]
#
# Defaults come from Ansible vars:
#   ezfs_snapshot_default_keep: {{ ezfs_snapshot_default_keep }}
#   ezfs_cli_snapshot_prefix:       {{ ezfs_cli_snapshot_prefix }}
#

KEEP="{{ ezfs_snapshot_default_keep }}"
PREFIX="{{ ezfs_cli_snapshot_prefix }}"
NOTE=""
RUNNING_ONLY=0

{% raw -%}
usage() {
  echo "Usage: $0 [--keep N] [--prefix STR] [--note STRING] [--running-only]" >&2
  exit 1
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --keep)
      shift || true
      [[ $# -gt 0 ]] || { echo "--keep requires a value" >&2; exit 1; }
      KEEP="$1"
      ;;
    --prefix)
      shift || true
      [[ $# -gt 0 ]] || { echo "--prefix requires a value" >&2; exit 1; }
      PREFIX="$1"
      ;;
    --note)
      shift || true
      [[ $# -gt 0 ]] || { echo "--note requires a value" >&2; exit 1; }
      NOTE="$1"
      ;;
    --running-only)
      RUNNING_ONLY=1
      ;;
    -*)
      echo "Unknown option: $1" >&2
      usage
      ;;
    *)
      echo "Unexpected positional argument: $1" >&2
      usage
      ;;
  esac
  shift || true
done

# Collect IDs from qm and pct
IDS=()

if command -v qm >/dev/null 2>&1; then
  if [[ "$RUNNING_ONLY" -eq 1 ]]; then
    while read -r line; do
      id=$(awk '{print $1}' <<<"$line")
      state=$(awk '{print $3}' <<<"$line")
      [[ "$id" =~ ^[0-9]+$ ]] || continue
      [[ "$state" == "running" ]] || continue
      IDS+=("$id")
    done < <(qm list 2>/dev/null | awk 'NR>1')
  else
    while read -r line; do
      id=$(awk '{print $1}' <<<"$line")
      [[ "$id" =~ ^[0-9]+$ ]] || continue
      IDS+=("$id")
    done < <(qm list 2>/dev/null | awk 'NR>1')
  fi
fi

if command -v pct >/dev/null 2>&1; then
  if [[ "$RUNNING_ONLY" -eq 1 ]]; then
    while read -r line; do
      id=$(awk '{print $1}' <<<"$line")
      status=$(awk '{print $5}' <<<"$line")
      [[ "$id" =~ ^[0-9]+$ ]] || continue
      [[ "$status" == "running" ]] || continue
      IDS+=("$id")
    done < <(pct list 2>/dev/null | awk 'NR>1')
  else
    while read -r line; do
      id=$(awk '{print $1}' <<<"$line")
      [[ "$id" =~ ^[0-9]+$ ]] || continue
      IDS+=("$id")
    done < <(pct list 2>/dev/null | awk 'NR>1')
  fi
fi

if [[ "${#IDS[@]}" -eq 0 ]]; then
  echo "No VM/CT IDs found."
  exit 0
fi

echo "Snapshotting ${#IDS[@]} guests (running-only=${RUNNING_ONLY}, keep=${KEEP}, prefix=${PREFIX})"

for id in "${IDS[@]}"; do
  echo ""
  echo "=== ID ${id} ==="
  if [[ -n "$NOTE" ]]; then
    ezfs-snapshot-vm "$id" --keep "$KEEP" --prefix "$PREFIX" --note "$NOTE"
  else
    ezfs-snapshot-vm "$id" --keep "$KEEP" --prefix "$PREFIX"
  fi
done

echo ""
echo "All snapshots done."
{%- endraw %}
