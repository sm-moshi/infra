#!/usr/bin/env bash
set -euo pipefail

DATASET="{{ sanoid_time_machine_dataset }}"
MAX_AGE_HOURS=36 # alert if no snapshot in the last 36h

last_line=$(zfs list -t snapshot -o name,creation -s creation "$DATASET" 2>/dev/null | tail -n 1 || true)

if [[ -z $last_line ]]; then
  echo "CRIT: No snapshots found for $DATASET"
  exit 2
fi

last_snap_name=$(awk '{print $1}' <<<"$last_line")
last_snap_ts=$(date -d "$(cut -d' ' -f2- <<<"$last_line")" +%s)
now_ts=$(date +%s)
age_hours=$(((now_ts - last_snap_ts) / 3600))

if ((age_hours > MAX_AGE_HOURS)); then
  echo "CRIT: Last snapshot for $DATASET is ${age_hours}h old (>$MAX_AGE_HOURS h): $last_snap_name"
  exit 2
fi

echo "OK: Last snapshot for $DATASET is ${age_hours}h old: $last_snap_name"
exit 0
