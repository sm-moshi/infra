---
# SPDX-License-Identifier: MIT-0
- name: Read VM runtime status
  ansible.builtin.command:
    argv:
      - qm
      - status
      - "{{ proxmox_template_debian13_vmid }}"
  register: proxmox_template_debian13_runtime_status
  changed_when: false
  failed_when: false

- name: Read VM config (for template detection)
  ansible.builtin.command:
    argv:
      - qm
      - config
      - "{{ proxmox_template_debian13_vmid }}"
  register: proxmox_template_debian13_qm_config_for_template
  changed_when: false

- name: Determine whether VM is already a template
  ansible.builtin.set_fact:
    proxmox_template_debian13_is_template: >-
      {{ 'template: 1' in proxmox_template_debian13_qm_config_for_template.stdout }}

- name: Convert VM to template
  ansible.builtin.command:
    argv:
      - qm
      - template
      - "{{ proxmox_template_debian13_vmid }}"
  when:
    - proxmox_template_debian13_ensure_template | bool
    - not proxmox_template_debian13_is_template
    - proxmox_template_debian13_runtime_status.stdout is search('stopped')
  changed_when: true

- name: Template already present (no-op)
  ansible.builtin.debug:
    msg: "VMID {{ proxmox_template_debian13_vmid }} is already a template; skipping conversion."
  when:
    - proxmox_template_debian13_ensure_template | bool
    - proxmox_template_debian13_is_template
