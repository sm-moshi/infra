---
# SPDX-License-Identifier: MIT-0
# Role: proxmox_template_debian13
# Purpose: build/update a Debian 13 Proxmox VM template via `qm` on the Proxmox node.
#
# Notes:
# - This role assumes it runs on a Proxmox VE node (or with delegated tasks to one).
# - Keep defaults conservative; override in inventory/group_vars/host_vars.

# --- Required identifiers (override these) ---
proxmox_template_debian13_vmid: "" # e.g. 9000
proxmox_template_debian13_name: "debian-13-template"

# Proxmox storage IDs
proxmox_template_debian13_storage: "nvme" # VM disks
proxmox_template_debian13_snippets_storage: "local" # snippets (cloud-init user-data), if used

# --- Base image (cloud image) ---
# Provide a URL to a Debian 13 cloud image (qcow2). Override to your preferred mirror.
proxmox_template_debian13_image_url: >-
  https://cdimage.debian.org/images/cloud/trixie/latest/debian-13-genericcloud-amd64.qcow2
# If empty, tasks should derive from URL basename.
proxmox_template_debian13_image_filename: ""

# Metadata URL for automatic checksum fetching (derived from image URL, .qcow2 -> .json)
# Set to empty string to disable automatic checksum fetching
proxmox_template_debian13_metadata_url: >-
  https://cdimage.debian.org/images/cloud/trixie/latest/debian-13-genericcloud-amd64.json

# Optional integrity checking (recommended): set at least one.
# Leave empty to fetch automatically from JSON metadata (if metadata_url is available)
proxmox_template_debian13_image_sha256: "" # e.g. "<hex>"
proxmox_template_debian13_image_sha512: "" # e.g. "<hex>"

# Where to stage downloads on the Proxmox node
proxmox_template_debian13_workdir: "/var/lib/vz/template/cache"

# --- VM hardware defaults ---
proxmox_template_debian13_cores: 2
proxmox_template_debian13_memory_mb: 2048

# Machine/firmware
proxmox_template_debian13_machine: "q35"
proxmox_template_debian13_bios: "ovmf"
proxmox_template_debian13_ostype: "l26"

# Disk/controller
proxmox_template_debian13_scsihw: "virtio-scsi-single"
proxmox_template_debian13_disk_format: "qcow2" # only relevant when importing

# Networking
proxmox_template_debian13_net_model: "virtio"
proxmox_template_debian13_bridge: "vmbr0"
proxmox_template_debian13_vlan_tag: "" # empty = untagged

# Agent
proxmox_template_debian13_qemu_agent: true

# --- Cloud-init defaults ---
proxmox_template_debian13_cloudinit_drive: "ide2"
proxmox_template_debian13_ciuser: "root"
proxmox_template_debian13_cipassword: "" # prefer SSH keys; leave empty to avoid password auth
proxmox_template_debian13_vga: "std"
proxmox_template_debian13_serial0: "socket"
proxmox_template_debian13_ssh_public_keys:
  - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILPZ1BiyzaJAkxFXY73FY61vFGv5BY1rcaWZClBYOx6f ansible@lab-ops-01"
  - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM0pBHrZiftYl7b6jN/5sC77QwXv9u9CZh8ytmYSRwVE sm@m0sh1.cc"

# DNS + IP config (optional; many users set this at clone-time instead)
proxmox_template_debian13_nameserver: ""
proxmox_template_debian13_searchdomain: ""
proxmox_template_debian13_ipconfig0: "" # e.g. "ip=dhcp" or "ip=10.0.0.50/24,gw=10.0.0.1"

# --- Template conversion behavior ---
# If true, the role will ensure the VM is converted to a template.
proxmox_template_debian13_ensure_template: true

# If true, the role may delete and recreate the VMID when a destructive rebuild is required.
proxmox_template_debian13_allow_recreate: false

# --- Advanced / safety toggles ---
# If true, role will run potentially host-impacting operations (qm importdisk, set, template).
proxmox_template_debian13_apply_changes: true
