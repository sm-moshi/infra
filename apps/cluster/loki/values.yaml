# Wrapper values for grafana/loki
#
# Goals:
# - SingleBinary deployment mode (homelab-scale)
# - Object storage in existing MinIO tenant
# - DHI Loki image (dhi.io/loki:3.6.4-debian13)
# - GitOps-friendly: credentials injected via Secret + config env expansion
#
# Secret requirements:
# - Secret name: monitoring-loki-s3
# - Keys:
#   - LOKI_S3_ENDPOINT (example: minio.minio-tenant.svc.cluster.local:443)
#   - LOKI_S3_REGION (example: us-east-1)
#   - LOKI_S3_ACCESS_KEY_ID
#   - LOKI_S3_SECRET_ACCESS_KEY

# All settings are for the upstream `grafana/loki` dependency chart (also named `loki`).
loki:
  # Ensure stable resource names for Grafana datasource URLs etc.
  fullnameOverride: loki

  deploymentMode: SingleBinary

  # Homelab-scale: disable chunks cache (default requests ~10Gi memory, which
  # cannot be scheduled in this cluster).
  chunksCache:
    enabled: false

  # Fix gateway CrashLoopBackOff: nginx expects a resolver address; using the
  # kube-dns Service IP avoids startup DNS resolution issues.
  gateway:
    nginxConfig:
      # CoreDNS is configured to return NXDOMAIN for AAAA; nginx can treat that
      # as resolution failure. Force A-only resolution.
      enableIPv6: false
      resolver: "10.43.0.10 valid=10s ipv6=off"

  imagePullSecrets:
    - name: kubernetes-dhi

  loki:
    image:
      registry: dhi.io
      repository: loki
      tag: "3.6.4-debian13"

    commonConfig:
      replication_factor: 1

    storage:
      bucketNames:
        chunks: loki-chunks
        ruler: loki-ruler
        admin: loki-admin
      type: s3
      s3:
        endpoint: ${LOKI_S3_ENDPOINT}
        region: ${LOKI_S3_REGION}
        accessKeyId: ${LOKI_S3_ACCESS_KEY_ID}
        secretAccessKey: ${LOKI_S3_SECRET_ACCESS_KEY}
        s3ForcePathStyle: true
        # MinIO uses tenant/service certificates; use TLS but skip verification inside the cluster.
        insecure: false
        http_config:
          insecure_skip_verify: true

    # Real install schema (avoid useTestSchema)
    schemaConfig:
      configs:
        # NOTE: date must be <= "now" when Loki starts.
        - from: 2026-01-01
          store: tsdb
          object_store: s3
          schema: v13
          index:
            prefix: loki_index_
            period: 24h

  singleBinary:
    # Required for ${ENV_VAR} expansion in the rendered Loki config.
    extraArgs:
      - -config.expand-env=true
    extraEnvFrom:
      - secretRef:
          name: monitoring-loki-s3

    replicas: 1

    nodeSelector:
      node-role.kubernetes.io/worker: "true"

    # Prefer the nodes recommended in docs/structure.md for Loki single-binary.
    affinity:
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 60
            preference:
              matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - horse02
                    - horse03

    persistence:
      enabled: true
      size: 10Gi
      storageClass: proxmox-csi-zfs-nvme-fast-retain

  monitoring:
    serviceMonitor:
      enabled: true
      labels:
        release: kube-prometheus-stack

  # Avoid deploying the SSD targets in SingleBinary mode.
  write:
    replicas: 0
  read:
    replicas: 0
  backend:
    replicas: 0
