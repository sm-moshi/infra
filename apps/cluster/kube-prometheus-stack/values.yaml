kube-prometheus-stack:
  fullnameOverride: kube-prometheus-stack
  namespaceOverride: monitoring

  prometheusOperator:
    enabled: true

    crds:
      enabled: false

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

    nodeSelector:
      node-role.kubernetes.io/worker: "true"

    admissionWebhooks:
      enabled: true
      patch:
        enabled: true
        nodeSelector:
          node-role.kubernetes.io/worker: "true"

  prometheus:
    enabled: true

    prometheusSpec:
      # Retention
      retention: 15d
      retentionSize: "45GB"

      # Replicas for HA
      replicas: 2

      # Resources
      resources:
        requests:
          cpu: 500m
          memory: 2Gi
        limits:
          cpu: 2000m
          memory: 4Gi

      # Storage
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: proxmox-csi-zfs-pgdata-retain
            accessModes: [ "ReadWriteOnce" ]
            resources:
              requests:
                storage: 50Gi

      # Service discovery: Monitor all namespaces
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      ruleSelectorNilUsesHelmValues: false

      # External labels
      externalLabels:
        cluster: "m0sh1-homelab"
        environment: "lab"

      # Node placement
      nodeSelector:
        node-role.kubernetes.io/worker: "true"

    # Ingress (via Traefik)
    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        cert-manager.io/cluster-issuer: cloudflare-origin-ca
        traefik.ingress.kubernetes.io/router.middlewares: traefik-basic-auth@kubernetescrd
        external-dns.alpha.kubernetes.io/hostname: prometheus.m0sh1.cc
      hosts:
        - prometheus.m0sh1.cc
      tls:
        - secretName: prometheus-tls
          hosts:
            - prometheus.m0sh1.cc

  alertmanager:
    enabled: true

    config:
      global:
        resolve_timeout: 5m

      route:
        group_by: [ 'cluster', 'alertname', 'namespace' ]
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 12h
        receiver: 'null'
        routes:
          - receiver: 'null'
            matchers:
              - alertname =~ "InfoInhibitor|Watchdog"

      receivers:
        - name: 'null'

      inhibit_rules:
        - source_matchers:
            - severity = 'critical'
          target_matchers:
            - severity =~ 'warning|info'
          equal: [ 'cluster', 'alertname', 'namespace' ]

    alertmanagerSpec:
      replicas: 2

      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: proxmox-csi-zfs-pgdata-retain
            accessModes: [ "ReadWriteOnce" ]
            resources:
              requests:
                storage: 10Gi

      nodeSelector:
        node-role.kubernetes.io/worker: "true"

    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        cert-manager.io/cluster-issuer: cloudflare-origin-ca
        traefik.ingress.kubernetes.io/router.middlewares: traefik-basic-auth@kubernetescrd
        external-dns.alpha.kubernetes.io/hostname: alertmanager.m0sh1.cc
      hosts:
        - alertmanager.m0sh1.cc
      tls:
        - secretName: alertmanager-tls
          hosts:
            - alertmanager.m0sh1.cc

  grafana:
    enabled: true

    # Admin credentials via SealedSecret
    admin:
      existingSecret: grafana-admin-secret
      userKey: admin-user
      passwordKey: admin-password

    # Persistence
    persistence:
      enabled: true
      storageClassName: proxmox-csi-zfs-pgdata-retain
      size: 10Gi

    # Resources
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi

    # Node placement
    nodeSelector:
      node-role.kubernetes.io/worker: "true"

    # Ingress
    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        cert-manager.io/cluster-issuer: cloudflare-origin-ca
        external-dns.alpha.kubernetes.io/hostname: grafana.m0sh1.cc
      hosts:
        - grafana.m0sh1.cc
      tls:
        - secretName: grafana-tls
          hosts:
            - grafana.m0sh1.cc

    # Grafana configuration
    grafana.ini:
      server:
        root_url: https://grafana.m0sh1.cc
      analytics:
        reporting_enabled: false
        check_for_updates: false
      auth.anonymous:
        enabled: false
      security:
        allow_embedding: false

    # Default dashboards
    defaultDashboardsEnabled: true
    defaultDashboardsTimezone: UTC

    # Dashboard providers
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/default

    # Sidecar for loading dashboards from ConfigMaps
    sidecar:
      dashboards:
        enabled: true
        label: grafana_dashboard
        labelValue: "1"
        searchNamespace: ALL
      datasources:
        enabled: true
        label: grafana_datasource
        labelValue: "1"
  nodeExporter:
    enabled: true

  kubeStateMetrics:
    enabled: true

  kubeApiServer:
    enabled: true

  kubelet:
    enabled: true

  kubeControllerManager:
    enabled: true

  kubeScheduler:
    enabled: true

  kubeProxy:
    enabled: true

  kubeEtcd:
    enabled: false

  defaultRules:
    create: true
    rules:
      alertmanager: true
      etcd: false
      configReloaders: true
      general: true
      k8s: true
      kubeApiserverAvailability: true
      kubeApiserverSlos: true
      kubeControllerManager: true
      kubelet: true
      kubeProxy: true
      kubePrometheusGeneral: true
      kubePrometheusNodeRecording: true
      kubernetesApps: true
      kubernetesResources: true
      kubernetesStorage: true
      kubernetesSystem: true
      kubeScheduler: true
      kubeStateMetrics: true
      network: true
      node: true
      nodeExporterAlerting: true
      nodeExporterRecording: true
      prometheus: true
      prometheusOperator: true
