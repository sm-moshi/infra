{{- $cnpg := .Values.cnpg | default dict -}}
{{- $cluster := $cnpg.cluster | default dict -}}
{{- $roles := $cnpg.roles | default list -}}
{{- if $cluster.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $cluster.name }}-init-roles
  namespace: {{ $cluster.namespace }}
  labels:
    app.kubernetes.io/name: cloudnative-pg
    app.kubernetes.io/component: init-roles
    app.kubernetes.io/part-of: {{ $cluster.name }}
  annotations:
    argocd.argoproj.io/sync-wave: "12"
    # Jobs are effectively immutable once created (selector + pod template). Model this as a
    # sync hook so ArgoCD deletes/recreates it on every sync where it is needed.
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
    # Ensure ArgoCD uses "replace" semantics (delete + create) rather than patching immutable Job fields.
    argocd.argoproj.io/sync-options: Replace=true
spec:
  backoffLimit: 2
  template:
    metadata:
      labels:
        app.kubernetes.io/name: cloudnative-pg
        app.kubernetes.io/component: init-roles
        app.kubernetes.io/part-of: {{ $cluster.name }}
    spec:
      serviceAccountName: {{ $cluster.name }}-init-roles
      restartPolicy: OnFailure
      containers:
        - name: init-roles
          image: {{ default $cluster.imageName $cluster.psqlImage | quote }}
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -lc
            - |
              # Keep this POSIX-sh compatible (the DHI postgres image is intentionally minimal).
              set -eu

              sql_lit() {
                # Escape a string for embedding inside a single-quoted SQL literal.
                # Postgres standard_conforming_strings makes backslashes non-special, so
                # doubling single-quotes is sufficient here.
                printf '%s' "$1" | sed "s/'/''/g"
              }

              echo "=== Initializing roles and databases ==="

              # Wait for primary service DNS
              until getent hosts {{ $cluster.name }}-rw.{{ $cluster.namespace }}.svc.cluster.local >/dev/null 2>&1; do
                echo "Waiting for CNPG RW service..."
                sleep 2
              done

              export PGHOST="{{ $cluster.name }}-rw.{{ $cluster.namespace }}.svc.cluster.local"
              export PGUSER="postgres"
              export PGDATABASE="postgres"

              echo "Connected to $PGHOST"

              {{- range $roles }}
              {{- if .enabled }}
              echo "Ensuring role exists: {{ .name }}"
              role="{{ .name }}"
              login_flag="{{ if (default true .login) }}LOGIN{{ else }}NOLOGIN{{ end }}"
              role_password=""
              {{- if .passwordSecret }}
              secret_path="/secrets/{{ .passwordSecret.name }}/password"
              if [ -f "$secret_path" ]; then
                # Secrets sometimes contain a trailing newline; strip it so SQL stays one-line.
                role_password="$(tr -d '\n' < "$secret_path")"
              fi
              {{- end }}
              if [ "$login_flag" = "NOLOGIN" ]; then
                role_password=""
              fi

              role_lit="$(sql_lit "$role")"
              login_lit="$(sql_lit "$login_flag")"

              if [ -n "$role_password" ]; then
                pw_lit="$(sql_lit "$role_password")"

                create_sql="$(psql -v ON_ERROR_STOP=1 -d postgres -A -t \
                  -c "SELECT format('CREATE ROLE %I %s PASSWORD %L', '${role_lit}', '${login_lit}', '${pw_lit}') WHERE NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '${role_lit}')")"
                if [ -n "$create_sql" ]; then
                  psql -v ON_ERROR_STOP=1 -d postgres -c "$create_sql"
                fi

                alter_sql="$(psql -v ON_ERROR_STOP=1 -d postgres -A -t \
                  -c "SELECT format('ALTER ROLE %I %s PASSWORD %L', '${role_lit}', '${login_lit}', '${pw_lit}')")"
                psql -v ON_ERROR_STOP=1 -d postgres -c "$alter_sql"
              else
                create_sql="$(psql -v ON_ERROR_STOP=1 -d postgres -A -t \
                  -c "SELECT format('CREATE ROLE %I %s', '${role_lit}', '${login_lit}') WHERE NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '${role_lit}')")"
                if [ -n "$create_sql" ]; then
                  psql -v ON_ERROR_STOP=1 -d postgres -c "$create_sql"
                fi

                alter_sql="$(psql -v ON_ERROR_STOP=1 -d postgres -A -t \
                  -c "SELECT format('ALTER ROLE %I %s', '${role_lit}', '${login_lit}')")"
                psql -v ON_ERROR_STOP=1 -d postgres -c "$alter_sql"
              fi
              {{- end }}
              {{- end }}

              {{- range $cnpg.databases }}
              {{- if .enabled }}
              echo "Processing database: {{ .name }}"
              db="{{ .name }}"
              owner="{{ .owner }}"
              db_exists="$(psql -v ON_ERROR_STOP=1 -d postgres -Atc "SELECT 1 FROM pg_database WHERE datname='${db}'")"
              if [ "${db_exists}" != "1" ]; then
                psql -v ON_ERROR_STOP=1 -d postgres -c "CREATE DATABASE \"${db}\" WITH OWNER \"${owner}\" TEMPLATE template0 ENCODING 'UTF8' LC_COLLATE='C' LC_CTYPE='C';"
              fi

              echo "âœ“ Database {{ .name }} ready"
              {{- end }}
              {{- end }}

              echo "=== Initialization complete ==="
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $cluster.name }}-superuser
                  key: password
          volumeMounts:
            {{- range $roles }}
            {{- if and .enabled .passwordSecret }}
            - name: secret-{{ .passwordSecret.name }}
              mountPath: /secrets/{{ .passwordSecret.name }}
              readOnly: true
            {{- end }}
            {{- end }}
      volumes:
        {{- range $roles }}
        {{- if and .enabled .passwordSecret }}
        - name: secret-{{ .passwordSecret.name }}
          secret:
            secretName: {{ .passwordSecret.name }}
            optional: false
        {{- end }}
        {{- end }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $cluster.name }}-init-roles
  namespace: {{ $cluster.namespace }}
  labels:
    app.kubernetes.io/name: cloudnative-pg
    app.kubernetes.io/component: init-roles
    app.kubernetes.io/part-of: {{ $cluster.name }}
  annotations:
    argocd.argoproj.io/sync-wave: "11"
{{- end }}
