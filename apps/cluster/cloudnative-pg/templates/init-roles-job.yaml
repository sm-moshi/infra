{{- $cnpg := .Values.cnpg | default dict -}}
{{- $cluster := $cnpg.cluster | default dict -}}
{{- $roles := $cnpg.roles | default list -}}
{{- if $cluster.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $cluster.name }}-init-roles
  namespace: {{ $cluster.namespace }}
  labels:
    app.kubernetes.io/name: cloudnative-pg
    app.kubernetes.io/component: init-roles
    app.kubernetes.io/part-of: {{ $cluster.name }}
  annotations:
    argocd.argoproj.io/sync-wave: "12"
    # Job pod templates are immutable; allow ArgoCD to delete/recreate the Job
    # when the helper image or command changes (e.g. DHI pin updates).
    argocd.argoproj.io/sync-options: Replace=true
spec:
  backoffLimit: 2
  template:
    metadata:
      labels:
        app.kubernetes.io/name: cloudnative-pg
        app.kubernetes.io/component: init-roles
        app.kubernetes.io/part-of: {{ $cluster.name }}
    spec:
      serviceAccountName: {{ $cluster.name }}-init-roles
      restartPolicy: OnFailure
      containers:
        - name: init-roles
          image: {{ default $cluster.imageName $cluster.psqlImage | quote }}
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -lc
            - |
              set -euo pipefail

              echo "=== Initializing roles and databases ==="

              # Wait for primary service DNS
              until getent hosts {{ $cluster.name }}-rw.{{ $cluster.namespace }}.svc.cluster.local >/dev/null 2>&1; do
                echo "Waiting for CNPG RW service..."
                sleep 2
              done

              export PGHOST="{{ $cluster.name }}-rw.{{ $cluster.namespace }}.svc.cluster.local"
              export PGUSER="postgres"
              export PGDATABASE="postgres"

              echo "Connected to $PGHOST"

              {{- range $roles }}
              {{- if .enabled }}
              echo "Ensuring role exists: {{ .name }}"
              role="{{ .name }}"
              login_flag="{{ if (default true .login) }}LOGIN{{ else }}NOLOGIN{{ end }}"
              role_password=""
              {{- if .passwordSecret }}
              secret_path="/secrets/{{ .passwordSecret.name }}/password"
              if [ -f "$secret_path" ]; then
                role_password="$(cat "$secret_path")"
              fi
              {{- end }}
              if [ "$login_flag" = "NOLOGIN" ]; then
                role_password=""
              fi

              if [ -n "$role_password" ]; then
                psql -v ON_ERROR_STOP=1 -v role="$role" -v login_flag="$login_flag" -v pw="$role_password" <<-EOSQL
                  DO $$
                  BEGIN
                    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = :'role') THEN
                      EXECUTE format('CREATE ROLE %I %s PASSWORD %L', :'role', :'login_flag', :'pw');
                    ELSE
                      EXECUTE format('ALTER ROLE %I %s PASSWORD %L', :'role', :'login_flag', :'pw');
                    END IF;
                  END
                  $$;
                EOSQL
              else
                psql -v ON_ERROR_STOP=1 -v role="$role" -v login_flag="$login_flag" <<-EOSQL
                  DO $$
                  BEGIN
                    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = :'role') THEN
                      EXECUTE format('CREATE ROLE %I %s', :'role', :'login_flag');
                    ELSE
                      EXECUTE format('ALTER ROLE %I %s', :'role', :'login_flag');
                    END IF;
                  END
                  $$;
                EOSQL
              fi
              {{- end }}
              {{- end }}

              {{- range $cnpg.databases }}
              {{- if .enabled }}
              echo "Processing database: {{ .name }}"

              psql -v ON_ERROR_STOP=1 <<-EOSQL
                SELECT 'CREATE DATABASE {{ .name }} WITH OWNER {{ .owner }} TEMPLATE template0 ENCODING ''UTF8'' LC_COLLATE=''C'' LC_CTYPE=''C'''
                WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .name }}')
                \gexec
              EOSQL

              echo "âœ“ Database {{ .name }} ready"
              {{- end }}
              {{- end }}

              echo "=== Initialization complete ==="
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $cluster.name }}-superuser
                  key: password
          volumeMounts:
            {{- range $roles }}
            {{- if and .enabled .passwordSecret }}
            - name: secret-{{ .passwordSecret.name }}
              mountPath: /secrets/{{ .passwordSecret.name }}
              readOnly: true
            {{- end }}
            {{- end }}
      volumes:
        {{- range $roles }}
        {{- if and .enabled .passwordSecret }}
        - name: secret-{{ .passwordSecret.name }}
          secret:
            secretName: {{ .passwordSecret.name }}
            optional: false
        {{- end }}
        {{- end }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $cluster.name }}-init-roles
  namespace: {{ $cluster.namespace }}
  labels:
    app.kubernetes.io/name: cloudnative-pg
    app.kubernetes.io/component: init-roles
    app.kubernetes.io/part-of: {{ $cluster.name }}
  annotations:
    argocd.argoproj.io/sync-wave: "11"
{{- end }}
