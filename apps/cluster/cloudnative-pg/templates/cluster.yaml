{{- $cnpg := .Values.cnpg | default dict -}}
{{- $cluster := $cnpg.cluster | default dict -}}
{{- $backup := $cluster.backup | default dict -}}
{{- $objectStoreName := $backup.objectStoreName | default (printf "%s-backups" $cluster.name) -}}
{{- if $cluster.enabled }}
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ $cluster.name }}
  namespace: {{ $cluster.namespace }}
  labels:
    app.kubernetes.io/name: cloudnative-pg
    app.kubernetes.io/part-of: {{ $cluster.name }}
  {{- with $cluster.annotations }}
  annotations:
{{ toYaml . | nindent 4 }}
  {{- end }}
spec:
  instances: {{ $cluster.instances }}
  imageName: {{ $cluster.imageName | quote }}
  enableSuperuserAccess: {{ $cluster.enableSuperuserAccess }}

  storage:
    storageClass: {{ $cluster.storage.class | quote }}
    size: {{ $cluster.storage.size | quote }}

  {{- with $cluster.walStorage }}
  walStorage:
    storageClass: {{ .class | quote }}
    size: {{ .size | quote }}
  {{- end }}

  {{- with $cluster.resources }}
  resources:
    {{- with .limits }}
    limits:
      cpu: {{ .cpu | quote }}
      memory: {{ .memory | quote }}
    {{- end }}
    {{- with .requests }}
    requests:
      cpu: {{ .cpu | quote }}
      memory: {{ .memory | quote }}
    {{- end }}
  {{- end }}

  {{- with $cluster.postgresql }}
  postgresql:
{{ toYaml . | nindent 4 }}
  {{- end }}

  {{- with $cluster.tolerations }}
  tolerations:
{{ toYaml . | nindent 4 }}
  {{- end }}

  {{- with $cluster.topologySpreadConstraints }}
  topologySpreadConstraints:
{{ toYaml . | nindent 4 }}
  {{- end }}

  {{- if $backup.enabled }}
  backup:
    barmanObjectStore:
      destinationPath: {{ $backup.destinationPath | quote }}
      endpointURL: {{ $backup.endpointURL | quote }}
      {{- with $backup.endpointCA }}
      endpointCA:
        name: {{ .name | quote }}
        key: {{ .key | quote }}
      {{- end }}
      s3Credentials:
        accessKeyId:
          name: {{ $backup.s3Credentials.accessKeyId.name | quote }}
          key: {{ $backup.s3Credentials.accessKeyId.key | quote }}
        secretAccessKey:
          name: {{ $backup.s3Credentials.secretAccessKey.name | quote }}
          key: {{ $backup.s3Credentials.secretAccessKey.key | quote }}
      {{- with $backup.wal }}
      wal:
{{ toYaml . | nindent 8 }}
      {{- end }}
      {{- with $backup.data }}
      data:
{{ toYaml . | nindent 8 }}
      {{- end }}
    {{- if $backup.retentionPolicy }}
    retentionPolicy: {{ $backup.retentionPolicy | quote }}
    {{- end }}
  {{- end }}

  {{- with $cluster.affinity }}
  affinity:
{{ toYaml . | nindent 4 }}
  {{- end }}

  {{- if $cnpg.roles }}
  {{- $enabledRoles := list -}}
  {{- range $cnpg.roles -}}
  {{- if .enabled -}}
  {{- $enabledRoles = append $enabledRoles . -}}
  {{- end -}}
  {{- end -}}
  {{- if gt (len $enabledRoles) 0 }}
  managed:
    roles:
    {{- range $enabledRoles }}
      - name: {{ .name | quote }}
        ensure: present
        {{- if .comment }}
        comment: {{ .comment | quote }}
        {{- end }}
        login: {{ default true .login }}
        {{- if .superuser }}
        superuser: {{ .superuser }}
        {{- end }}
        {{- if .inRoles }}
        inRoles:
{{ toYaml .inRoles | nindent 10 }}
        {{- end }}
        {{- if .passwordSecret }}
        passwordSecret:
          name: {{ .passwordSecret.name | quote }}
        {{- end }}
    {{- end }}
  {{- end }}
  {{- end }}
{{- end }}
