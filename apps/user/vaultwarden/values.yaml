# Vaultwarden (Bitwarden-compatible server) configuration
# Uses shared CNPG cluster (cnpg-main)

vaultwarden:
  # Domain configuration (REQUIRED for proper functionality)
  domain: "https://vault.m0sh1.cc"

  # Image configuration (Harbor proxy cache)
  image:
    registry: harbor.m0sh1.cc/hub
    repository: vaultwarden/server
    tag: "1.35.2-alpine"
    pullPolicy: IfNotPresent

  # Replicas
  replicas: 1

  # Database configuration (shared CNPG cluster)
  database:
    type: postgresql
    existingSecret: vaultwarden-postgres-auth
    existingSecretKey: uri
    connectionRetries: 15
    maxConnections: 10

  # Persistent storage
  storage:
    data:
      name: vaultwarden-data
      size: 5Gi
      class: proxmox-csi-zfs-nvme-general-retain
      accessMode: ReadWriteOnce

    attachments:
      name: vaultwarden-attachments
      size: 10Gi
      class: proxmox-csi-zfs-nvme-general-retain
      accessMode: ReadWriteOnce

  # Admin token (argon2 hashed)
  adminToken:
    existingSecret: vaultwarden-admin-token
    existingSecretKey: token

  # Ingress configuration (Traefik)
  ingress:
    enabled: true
    class: traefik
    nginxIngressAnnotations: false
    additionalAnnotations:
      kubernetes.io/ingress.class: traefik
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
    tls: true
    hostname: vault.m0sh1.cc
    tlsSecret: wildcard-m0sh1-cc

  # General settings
  signupsAllowed: false  # Disable public signups
  invitationsAllowed: true  # Allow invites from existing users
  signupsVerify: true
  showPassHint: false
  webVaultEnabled: "true"

  # Security settings
  requireDeviceEmail: "true"

  # Logging
  extendedLogging: "true"
  logging:
    logLevel: "info"

  # Icon service
  iconService: "internal"
  iconBlacklistNonGlobalIps: "true"

  # SMTP configuration (optional, can be added later)
  smtp:
    host: ""
    from: ""
    port: 587
    security: "starttls"

  # Service configuration
  service:
    type: ClusterIP
    sessionAffinity: ClientIP
    sessionAffinityConfig:
      clientIP:
        timeoutSeconds: 10800

  # Rocket (web server) configuration
  rocket:
    address: "0.0.0.0"
    port: "8080"
    workers: "10"

  # Probes
  livenessProbe:
    enabled: true
    path: /alive
    initialDelaySeconds: 10
    periodSeconds: 10
    failureThreshold: 10

  readinessProbe:
    enabled: true
    path: /alive
    initialDelaySeconds: 5
    periodSeconds: 10
    failureThreshold: 3

  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  # Node placement
  nodeSelector:
    node-role.kubernetes.io/worker: "true"

  tolerations: []

  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 80
          preference:
            matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values: ["pve-01"]
        - weight: 60
          preference:
            matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values: ["pve-02"]

  # Security context
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

  podSecurityContext:
    fsGroup: 1000
