semaphore:
  enabled: true
  image:
    repository: docker.io/semaphoreui/semaphore
    tag: "v2.16.51"
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 3000
    internalPort: 3000

  ingress:
    enabled: true
    className: traefik
    annotations:
      kubernetes.io/ingress.class: traefik
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
      # external-dns.alpha.kubernetes.io/hostname: semaphore.m0sh1.cc
    hosts:
    - host: semaphore.m0sh1.cc
      paths:
      - path: /
        pathType: Prefix
    tls:
    - secretName: wildcard-m0sh1-cc
      hosts:
      - semaphore.m0sh1.cc

  general:
    host: "https://semaphore.m0sh1.cc"
    tmpPath: /var/lib/semaphore
    # Start with server-only to keep blast radius small; runners can be added later.
    useRemoteRunner: false

  persistence:
    enabled: true
    size: 5Gi
    storageClass: proxmox-csi-zfs-nvme-general-retain
    accessModes:
    - ReadWriteOnce

  database:
    type: postgres
    # NOTE: Semaphore image uses `nc` (musl) in its start script to wait for DB.
    # In our cluster, Service AAAA lookups return NXDOMAIN, which makes some musl
    # resolver paths fail hard. Use ClusterIP to avoid DNS entirely.
    host: "10.43.178.218" # cnpg-main-rw.apps.svc.cluster.local
    port: 5432
    name: semaphore
    usernameFromSecret: true
    username: semaphore
    existingSecret: semaphore-postgres-auth
    passwordKey: password
    options:
      sslmode: disable

  admin:
    create: true
    existingSecret: semaphore-admin

  secrets:
    existingSecret: semaphore-secrets

  # Runner integration is intentionally deferred until the server is stable.

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 1
      memory: 768Mi
  nodeSelector:
    node-role.kubernetes.io/worker: "true"
  tolerations: []
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 80
        preference:
          matchExpressions:
          - key: topology.kubernetes.io/zone
            operator: In
            values: ["pve-01"]
      - weight: 60
        preference:
          matchExpressions:
          - key: topology.kubernetes.io/zone
            operator: In
            values: ["pve-02"]
  # tolerations:
  #   - key: node-role.kubernetes.io/control-plane
  #     operator: Exists
  #     effect: NoSchedule
