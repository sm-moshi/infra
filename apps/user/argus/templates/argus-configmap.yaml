{{- $configName := .Values.argus.config.useExistingConfigMap | default "argus-config" -}}
{{- $config := (fromYaml (.Files.Get "config/argus.yaml")) | default dict -}}
{{- $servicesRaw := get $config "service" | default dict -}}
{{- $services := dict -}}
{{- if kindIs "map" $servicesRaw -}}
  {{- $services = $servicesRaw -}}
{{- end -}}
{{- range $name, $svc := $services -}}
  {{- if kindIs "map" $svc -}}
    {{- $dashboard := get $svc "dashboard" | default dict -}}
    {{- if not (hasKey $dashboard "icon") -}}
      {{- $lv := get $svc "latest_version" | default dict -}}
      {{- $lvType := get $lv "type" | default "" -}}
      {{- if eq $lvType "github" -}}
        {{- $repo := get $lv "url" | default "" -}}
        {{- $owner := index (splitList "/" $repo) 0 | default "" -}}
        {{- if $owner -}}
          {{- $_ := set $dashboard "icon" (printf "https://avatars.githubusercontent.com/%s?s=200&v=4" $owner) -}}
          {{- if not (hasKey $dashboard "icon_link_to") -}}
            {{- $_ := set $dashboard "icon_link_to" (printf "https://github.com/%s" $repo) -}}
          {{- end -}}
        {{- end -}}
      {{- else if eq $lvType "web" -}}
        {{- $url := get $lv "url" | default "" -}}
        {{- if regexMatch "^https?://" $url -}}
          {{- $domain := regexReplaceAll "^https?://([^/]+).*" "$1" $url -}}
          {{- if $domain -}}
            {{- $_ := set $dashboard "icon" (printf "https://www.google.com/s2/favicons?sz=128&domain=%s" $domain) -}}
            {{- if not (hasKey $dashboard "icon_link_to") -}}
              {{- $_ := set $dashboard "icon_link_to" $url -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
      {{- $_ := set $svc "dashboard" $dashboard -}}
    {{- end -}}
    {{- $_ := set $services $name $svc -}}
  {{- end -}}
{{- end -}}
{{- $_ := set $config "service" $services -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $configName }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
data:
  {{ .Values.argus.config.filename | default "config.yml" }}: |
{{- toYaml $config | nindent 4 }}
