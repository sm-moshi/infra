replicaCount: 1

image:
  repository: ghcr.io/harborguard/harborguard
  tag: "latest@sha256:73ca7191ab674a7816b0b7edd2d7e19534fe3016a4110e3fcbcab5833d6d3d53"
  pullPolicy: Always

nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  name: ""

podAnnotations:
  argocd.argoproj.io/sync-wave: "15"
podLabels: {}

service:
  type: ClusterIP
  port: 3000

ingress:
  enabled: true
  className: traefik
  annotations:
    # external-dns.alpha.kubernetes.io/hostname: guard.m0sh1.cc
    kubernetes.io/ingress.class: traefik
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
  hosts:
  - host: guard.m0sh1.cc
    paths:
    - path: /
      pathType: Prefix
  tls:
  - hosts:
    - guard.m0sh1.cc
    secretName: wildcard-m0sh1-cc

resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: "2"
    memory: 2Gi

# Docker-in-Docker sidecar for isolated Docker operations
dind:
  enabled: true
  image:
    repository: "docker.io/docker"
    tag: "29.2.0-rc.1-dind-alpine3.23@sha256:09ea819ff1a6023f2e92dba633096b93e00f786be547b261ce7d73297260a024"
  resources:
    requests:
      cpu: 400m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 1Gi

# HarborGuard environment variables
env:
  PORT: "3000"
  HOSTNAME: "0.0.0.0"
  LOG_LEVEL: "info"
  MAX_CONCURRENT_SCANS: "5"
  SCAN_TIMEOUT_MINUTES: "30"
  ENABLED_SCANNERS: "trivy,grype,syft,dockle,osv,dive"
  # Scanner cache directories
  TRIVY_CACHE_DIR: "/workspace/cache/trivy"
  GRYPE_DB_CACHE_DIR: "/workspace/cache/grype"
  SYFT_CACHE_DIR: "/workspace/cache/syft"
  SCANNER_WORKDIR: "/workspace"
  PATCH_WORKDIR: "/workspace/patches"
  # Harbor integration
  HARBOR_REGISTRY_URL: "harbor.m0sh1.cc"
  HARBOR_API_URL: "https://harbor.m0sh1.cc/api/v2.0"
  HARBOR_INTERNAL_URL: "harbor-registry.apps.svc.cluster.local:5000"

# Database connection to CloudNative-PG
database:
  url: "" # Provided via existingSecret
  existingSecret:
    name: "harborguard-db-secret"
    key: "DATABASE_URL"

# Harbor credentials (reuse harbor-build-user for push/pull access)
harbor:
  enabled: true
  credentials:
    existingSecret: harbor-build-user
    usernameKey: username
    passwordKey: password

# Docker socket via DinD sidecar (emptyDir, not hostPath)
dockerSocket:
  enabled: true
  mountPath: /var/run/docker.sock

# Autopatch requires privileged container execution
autopatch:
  enabled: true

securityContext:
  runAsNonRoot: false
  allowPrivilegeEscalation: true
  privileged: true
  readOnlyRootFilesystem: false

# Schedule to worker nodes (preferred) or control plane if needed
# nodeSelector: {}
# tolerations:
# - key: workload.m0sh1.cc
#   operator: Exists
#   effect: NoSchedule
# - key: node-role.kubernetes.io/control-plane
#   operator: Exists
#   effect: NoSchedule
# affinity:
#   nodeAffinity:
#     preferredDuringSchedulingIgnoredDuringExecution:
#     - weight: 100
#       preference:
#         matchExpressions:
#         - key: node-role.kubernetes.io/worker
#           operator: Exists

# Persistent storage for scanner caches and patches (50GB)
persistence:
  enabled: true
  accessMode: ReadWriteOnce
  size: 50Gi
  storageClassName: "proxmox-csi-zfs-registry-retain"
  mountPath: /workspace

networkPolicy:
  enabled: false
  # allow egress to Harbor + internet as needed; tighten later
  egress:
  - to:
    - namespaceSelector: {}
    ports: []
pdb:
  enabled: false
  minAvailable: 0
