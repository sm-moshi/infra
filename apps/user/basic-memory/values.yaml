replicaCount: 1
revisionHistoryLimit: 1

image:
  repository: harbor.m0sh1.cc/ghcr/basicmachines-co/basic-memory
  tag: "latest"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 8000
  targetPort: 8000

ingress:
  enabled: true
  className: traefik
  annotations:
    kubernetes.io/ingress.class: traefik
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    cert-manager.io/cluster-issuer: origin-ca-issuer
  hosts:
    - host: basic-memory.m0sh1.cc
      paths:
        - path: /
          pathType: Prefix
  tls:
    - hosts:
        - basic-memory.m0sh1.cc
      secretName: wildcard-m0sh1-cc

env:
  BASIC_MEMORY_DEFAULT_PROJECT: "main"
  BASIC_MEMORY_LOG_LEVEL: "INFO"

persistence:
  enabled: true
  storageClass: proxmox-csi-zfs-nvme-general-retain
  size: 5Gi
  mountPath: /app/data
  accessMode: ReadWriteOnce

resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Prefer horse04 per docs/structure.md
nodeSelector:
  node-role.kubernetes.io/worker: "true"

tolerations: []

affinity:
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values: ["horse04"]
      - weight: 80
        preference:
          matchExpressions:
            - key: topology.kubernetes.io/zone
              operator: In
              values: ["pve-01"]
      - weight: 60
        preference:
          matchExpressions:
            - key: topology.kubernetes.io/zone
              operator: In
              values: ["pve-02"]

# Recreate strategy for PVC-backed workload
strategy:
  type: Recreate

securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

# Health checks - use TCP socket since no dedicated health endpoint
livenessProbe:
  tcpSocket:
    port: 8000
  initialDelaySeconds: 10
  periodSeconds: 30
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  tcpSocket:
    port: 8000
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# CouchDB for Obsidian LiveSync
couchdb:
  enabled: true
  image:
    repository: harbor.m0sh1.cc/dhi/couchdb
    tag: "3.5.1-debian13"
    pullPolicy: IfNotPresent
  existingSecret:
    name: basic-memory-couchdb
    userKey: COUCHDB_USER
    passwordKey: COUCHDB_PASSWORD
  persistence:
    size: 2Gi
    storageClass: proxmox-csi-zfs-nvme-general-retain
  service:
    port: 5984
  ingress:
    enabled: true
    host: livesync.m0sh1.cc
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# livesync-bridge: CouchDB <-> filesystem bidirectional sync
livesync:
  enabled: true
  image:
    repository: harbor.m0sh1.cc/apps/livesync-bridge
    tag: "0.1.2"
    pullPolicy: IfNotPresent
  database: obsidian
  passphrase: ""
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi
