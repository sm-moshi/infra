replicaCount: 1
revisionHistoryLimit: 1

image:
  repository: ghcr.io/basicmachines-co/basic-memory
  tag: "latest"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 8000
  targetPort: 8000

ingress:
  enabled: true
  className: traefik
  annotations:
    kubernetes.io/ingress.class: traefik
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    cert-manager.io/cluster-issuer: origin-ca-issuer
    # external-dns.alpha.kubernetes.io/hostname: basic-memory.m0sh1.cc
  hosts:
    - host: basic-memory.m0sh1.cc
      paths:
        - path: /
          pathType: Prefix
  tls:
    - hosts:
        - basic-memory.m0sh1.cc
      secretName: wildcard-m0sh1-cc

env:
  # Basic Memory environment variables
  BASIC_MEMORY_DEFAULT_PROJECT: "main"
  BASIC_MEMORY_LOG_LEVEL: "INFO"

persistence:
  enabled: true
  storageClass: proxmox-csi-zfs-nvme-general-retain
  size: 5Gi
  mountPath: /app/data
  accessMode: ReadWriteOnce

resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Prefer horse04 per docs/structure.md
nodeSelector:
  node-role.kubernetes.io/worker: "true"

tolerations: []

affinity:
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values: ["horse04"]
      - weight: 80
        preference:
          matchExpressions:
            - key: topology.kubernetes.io/zone
              operator: In
              values: ["pve-01"]
      - weight: 60
        preference:
          matchExpressions:
            - key: topology.kubernetes.io/zone
              operator: In
              values: ["pve-02"]

# Recreate strategy for PVC-backed workload
strategy:
  type: Recreate

securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  capabilities:
    drop:
      - ALL

# Health checks - use TCP socket since no dedicated health endpoint
livenessProbe:
  tcpSocket:
    port: 8000
  initialDelaySeconds: 10
  periodSeconds: 30
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  tcpSocket:
    port: 8000
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Git sync for Obsidian integration
gitSync:
  enabled: true
  repo: "https://github.com/sm-moshi/knowledge-base.git"
  branch: "main"
  username: "sm-moshi"
  # Reuse existing GitHub PAT from argocd namespace (distributed by reflector)
  existingSecret:
    name: "repo-github-m0sh1-infra"
    key: "password"  # The ghp_ token
  depth: 1  # Shallow clone for faster sync
  period: "30s"  # Pull from Git every 30 seconds
  image:
    repository: "registry.k8s.io/git-sync/git-sync"
    tag: "v4.2.1"
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi
