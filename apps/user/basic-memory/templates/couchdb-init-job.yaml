{{- if .Values.couchdb.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "basic-memory.fullname" . }}-couchdb-init
  labels:
    {{- include "basic-memory.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    # Ensure subsequent syncs can recreate the hook even if a previous run failed.
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
spec:
  backoffLimit: 5
  template:
    metadata:
      labels:
        {{- include "basic-memory.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: couchdb-init
    spec:
      restartPolicy: OnFailure
      automountServiceAccountToken: false
      containers:
      - name: couchdb-init
        image: curlimages/curl:latest
        command:
          - /bin/sh
          - -c
          - |
            set -e
            # Avoid musl DNS issues (curlimages/curl is Alpine/musl). Prefer ServiceLinks env vars (no DNS),
            # and fall back to the Service FQDN if those aren't present.
            COUCH_HOST="${BASIC_MEMORY_COUCHDB_SERVICE_HOST:-{{ include "basic-memory.fullname" . }}-couchdb.{{ .Release.Namespace }}.svc.cluster.local}"
            COUCH_PORT="${BASIC_MEMORY_COUCHDB_SERVICE_PORT:-{{ .Values.couchdb.service.port }}}"
            COUCH_BASE="http://${COUCH_HOST}:${COUCH_PORT}"
            # Don't embed credentials in the URL: passwords can contain '/' which breaks URL parsing.
            COUCH_AUTH="${COUCHDB_USER}:${COUCHDB_PASSWORD}"

            echo "Waiting for CouchDB..."
            ready="false"
            for i in $(seq 1 30); do
              code="$(curl -sS -o /dev/null -u "${COUCH_AUTH}" -w '%{http_code}' "${COUCH_BASE}/" || true)"
              if [ "${code}" = "200" ]; then
                ready="true"
                echo "CouchDB is ready"
                break
              fi
              echo "Attempt ${i}/30 - CouchDB not ready (HTTP ${code})"
              sleep 5
            done

            if [ "${ready}" != "true" ]; then
              echo "CouchDB never became ready"
              exit 1
            fi

            echo "Creating database '{{ .Values.livesync.database }}' (idempotent)..."
            curl -sf -u "${COUCH_AUTH}" -X PUT "${COUCH_BASE}/{{ .Values.livesync.database }}" || true

            echo "Verifying database..."
            curl -sf -u "${COUCH_AUTH}" "${COUCH_BASE}/{{ .Values.livesync.database }}" | head -c 200
            echo ""
            echo "CouchDB init complete"
        env:
        - name: COUCHDB_USER
          valueFrom:
            secretKeyRef:
              name: {{ .Values.couchdb.existingSecret.name }}
              key: {{ .Values.couchdb.existingSecret.userKey }}
        - name: COUCHDB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.couchdb.existingSecret.name }}
              key: {{ .Values.couchdb.existingSecret.passwordKey }}
        resources:
          requests:
            cpu: 10m
            memory: 16Mi
          limits:
            cpu: 50m
            memory: 32Mi
{{- end }}
