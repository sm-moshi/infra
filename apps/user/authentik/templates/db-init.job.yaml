apiVersion: batch/v1
kind: Job
metadata:
  name: authentik-db-init
  labels:
    app.kubernetes.io/name: authentik
    app.kubernetes.io/component: db-init
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
    argocd.argoproj.io/sync-wave: "0"
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: authentik
        app.kubernetes.io/component: db-init
    spec:
      restartPolicy: Never
      containers:
        - name: db-init
          image: {{ required "dbInit.image is required" .Values.dbInit.image | quote }}
          imagePullPolicy: {{ .Values.dbInit.imagePullPolicy | default "IfNotPresent" | quote }}
          securityContext:
            runAsNonRoot: true
            runAsUser: 70
            runAsGroup: 70
            allowPrivilegeEscalation: false
          env:
            - name: PGHOST
              value: cnpg-main-rw.apps.svc.cluster.local
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: cnpg-main-superuser
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: cnpg-main-superuser
                  key: password
            - name: APP_DB
              value: authentik
            - name: APP_OWNER
              value: authentik
          command:
            - /bin/sh
            - -ec
            - |
              echo "Waiting for Postgres RW endpoint (${PGHOST}:${PGPORT})..."

              i=0
              while [ "$i" -lt 60 ]; do
                if pg_isready -h "${PGHOST}" -p "${PGPORT}" -U "${PGUSER}" >/dev/null 2>&1; then
                  break
                fi
                i=$((i+1))
                sleep 2
              done

              pg_isready -h "${PGHOST}" -p "${PGPORT}" -U "${PGUSER}"

              echo "Checking role ${APP_OWNER} exists (created by CNPG init-roles job)..."
              role_exists="$(psql -v ON_ERROR_STOP=1 -d postgres -Atc "SELECT 1 FROM pg_roles WHERE rolname='${APP_OWNER}'")"
              if [ "${role_exists}" != "1" ]; then
                echo "Role ${APP_OWNER} does not exist (expected CNPG init-roles Job to have created it)."
                exit 1
              fi

              echo "Ensuring database ${APP_DB} exists..."
              db_exists="$(psql -v ON_ERROR_STOP=1 -d postgres -Atc "SELECT 1 FROM pg_database WHERE datname='${APP_DB}'")"
              if [ "${db_exists}" = "1" ]; then
                echo "Database exists; ensuring owner is ${APP_OWNER}..."
                psql -v ON_ERROR_STOP=1 -d postgres -c "ALTER DATABASE \"${APP_DB}\" OWNER TO \"${APP_OWNER}\";"
              else
                echo "Creating database ${APP_DB} owned by ${APP_OWNER}..."
                psql -v ON_ERROR_STOP=1 -d postgres -c "CREATE DATABASE \"${APP_DB}\" OWNER \"${APP_OWNER}\";"
              fi

              echo "Database init complete."
