dbInit:
  image: harbor.m0sh1.cc/dhi/postgres:18.1-debian13@sha256:086748e4e33806af10483b2dd4bc287d7102a8cc3d11d73f5cad9886c02f3b87
  imagePullPolicy: IfNotPresent

authentik:
  # All Authentik configuration is provided via SealedSecrets in apps/user/secrets-apps.
  authentik:
    existingSecret:
      secretName: authentik-config

  # Use the shared CNPG cluster (apps/cnpg-main).
  postgresql:
    enabled: false

  # Trust the in-cluster MinIO tenant TLS (issuer: k3s server CA) for S3-backed storage.
  global:
    env:
      # Authentik config is sourced from SealedSecrets (generic keys) and mapped into
      # the expected AUTHENTIK_* env vars here to avoid storing those env var names
      # in SealedSecret manifests (SonarCloud Security Hotspots false-positives).
      - name: AUTHENTIK_SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: authentik-config
            key: secret_key
      - name: AUTHENTIK_BOOTSTRAP_PASSWORD
        valueFrom:
          secretKeyRef:
            name: authentik-config
            key: bootstrap_pw
      - name: AUTHENTIK_BOOTSTRAP_TOKEN
        valueFrom:
          secretKeyRef:
            name: authentik-config
            key: bootstrap_token

      # CNPG (shared cluster)
      - name: AUTHENTIK_POSTGRESQL__HOST
        value: cnpg-main-rw.apps.svc.cluster.local
      - name: AUTHENTIK_POSTGRESQL__PORT
        value: "5432"
      - name: AUTHENTIK_POSTGRESQL__NAME
        value: authentik
      - name: AUTHENTIK_POSTGRESQL__USER
        value: authentik
      - name: AUTHENTIK_POSTGRESQL__PASSWORD
        valueFrom:
          secretKeyRef:
            name: authentik-postgres-auth
            key: password

      # S3-backed storage (MinIO tenant, internal HTTPS)
      - name: AUTHENTIK_STORAGE__BACKEND
        value: s3
      - name: AUTHENTIK_STORAGE__S3__ENDPOINT
        value: https://minio.minio-tenant.svc.cluster.local
      - name: AUTHENTIK_STORAGE__S3__BUCKET_NAME
        value: authentik-media
      - name: AUTHENTIK_STORAGE__S3__ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: authentik-config
            key: s3_access
      - name: AUTHENTIK_STORAGE__S3__SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: authentik-config
            key: s3_secret
      - name: AUTHENTIK_STORAGE__S3__REGION
        value: us-east-1
      - name: AUTHENTIK_STORAGE__S3__USE_SSL
        value: "true"

      - name: AWS_CA_BUNDLE
        value: /etc/ssl/certs/minio-ca/ca.crt
    volumes:
      - name: minio-ca
        configMap:
          name: minio-ca
          items:
            - key: ca.crt
              path: ca.crt
    volumeMounts:
      - name: minio-ca
        mountPath: /etc/ssl/certs/minio-ca/ca.crt
        subPath: ca.crt
        readOnly: true

  server:
    replicas: 2
    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        kubernetes.io/ingress.class: traefik
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
        traefik.ingress.kubernetes.io/router.tls: "true"
      hosts:
        - auth.m0sh1.cc
      tls:
        - secretName: wildcard-m0sh1-cc
          hosts:
            - auth.m0sh1.cc

  worker:
    replicas: 2
